---
title: "R Finals"
output: html_notebook
---

# Introdução
O seguinte projeto é o trabalho final da disciplina de *Introdução ao R Aplicado em Ciência de Dados*, da EPGE.

Utilizaremos dados estatísticos da Secretaria de Segurança Pública do Estado de São Paulo, disponíveis para download em https://basedosdados.org/dataset/br-sp-gov-ssp, e a planilha de informações dos municípios do estado de São Paulo, elaborada pelo IBGE e disponível em https://www.ibge.gov.br/cidades-e-estados/sp/sao-paulo.html. Os dois arquivos .csv baixados já estão no repositório GitHub desse projeto, e portanto, tendo-o clonado na sua máquina, não é necessário realizar o download nas fontes.

# Preparação
## Importando os pacotes
```{r}
install.packages("tidyverse")
install.packages("psych")

library(tidyverse)
library(readxl) #apesar de ser baixado no pacote "tidyverse", precisamos carregar separadamente
library(psych)
library(lubridate) # tambem parte do tidyverse
```

## Importando a base de dados

Lendo duas linhas do arquivo para verificar o formato do CSV (evitando assim erros com o delimitador no momento de salvar os dados, por exemplo)
```{r}
read_lines("ocorrencias_registradas.csv", n_max = 2)
```
Já podemos reparar que teremos dados NA na nossa base, porém resolveremos isso mais a diante. Como o separador é vírgula, podemos utilizar o leitor de CSV padrão.

```{r}
ssp <- read_csv("ocorrencias_registradas.csv")
```

Também utilizaremos a planilha do IBGE com os municípios do estado de São Paulo. Analisando os dados, percebemos que as duas primeiras linhas não contém dados, e após a linha 645, temos metadados e fontes da base. Também reparamos que o símbolo "-" é utilizado para representar NA. Todos esses detalhes foram considerados ao ler o arquivo no projeto. 

```{r}
mun <- read_excel("sp-municipios.xlsx", na="-", skip = 2, n_max = 645)
```

## Primeiras olhadas nos DFs

Vamos verificar se estamos utilizando dataframes do tipo Tibble. 
```{r}
class(ssp)
class(mun)
```
### Dataframe principal (SSP)

Vamos verificar os nomes das colunas e o tipo do dado de cada uma.

```{r}
spec(ssp)
```
Vamos salvar os nomes das colunas em uma variável chamada "meta_ssp".
```{r}
meta_ssp <- names(ssp)
meta_ssp
```
E olharemos os primeiros 6 registros de nossa tabela.
```{r}
head(ssp)
```

Por fim, daremos uma olhada em dados estatísticos (desvio padrão, média, mediana, mínimo, máximo e outros) de nossas colunas. 

```{r}
describe(ssp)
```
A análise desses dados estatísticos não faz sentido para todas as varíaveis (por exemplo, não faz sentido calcular a média, desvio padrão, etc, de ano e mês) e, como há muitos dados, para outras faria mais sentido fazer uma investigação anual (é muito mais relevante comparar a média de crimes por ano e se ela está crescendo ou diminuindo do que apenas ver a média do dataset completo). Análises mais complexas serão feitas na seção de Visualização de Dados do projeto.

### Dataframe secundário (MUN)

Seguiremos o mesmo processo para esse dataframe.

```{r}
meta_mun <- names(mun)
meta_mun
```

```{r}
head(mun)
```
```{r}
describe(mun)
```


## Limpando os dados


Primeiro, retiramos algumas colunas que consideramos desnecessárias para a nossa análise na tabela mun (Gentílico, Prefeito, Receitas e Despesas) 
```{r}
mun2 <- mun %>%
  select(!c(3,4,11,12))

names(mun2)
```
Depois, renomeamos as colunas por questão de simplificação.

```{r}
colnames(mun2) <- c("nome", "id_municipio", "area", "pop", "den", "escol", "idh", "mort_inf", "PIB_percap")
names(mun2)
```

Para o dataset principal, podemos trocar o ID do município pelo seu nome. Mas primeiro, será que temos os mesmos municípios nos dois datasets?

```{r}
all((unique(ssp$id_municipio)), (mun2$id_municipio))
```
Sim! Podemos prosseguir com a limpeza do dataframe. Utilizamos a tabela MUN2 para substituir o id do município pelo nome. Também substituimos as colunas de ano e mes por uma com a data completa no formato lubridate.  

```{r}
ssp2 <- ssp %>%
  inner_join(mun2[,c("nome","id_municipio")],by = "id_municipio") %>%
  relocate("nome", .before = "id_municipio") %>%
  select(!id_municipio) %>%
  mutate(data = make_date(ano,mes,1),.before=ano) %>%
  select(-ano, -mes)

head(ssp2)
```

